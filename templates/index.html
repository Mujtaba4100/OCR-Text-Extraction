<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Document Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f7f9fb; }
    .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .output-box { white-space: pre-wrap; background: #f8f9fa; padding: 16px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-size: 0.85rem; }
    .search-result { border-left: 4px solid #0d6efd; background: #fff; }
    .score-badge { font-size: 0.75rem; }
    .doc-type-badge { font-size: 0.8rem; }
    .metadata-table { font-size: 0.85rem; }
    .metadata-table td { padding: 0.25rem 0.5rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="text-center mb-4"><i class="bi bi-file-earmark-text"></i> AI Document Management System</h2>
    
    <div class="row g-4">
      <!-- Left Column: Upload & Extracted Data -->
      <div class="col-lg-6">
        <!-- Upload Card -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-cloud-upload"></i> Upload Document</h5>
          <form method="POST" enctype="multipart/form-data">
            <div class="mb-3">
              <input type="file" class="form-control" name="file" accept=".pdf,.png,.jpg,.jpeg,.tif,.tiff" required>
            </div>
            <button class="btn btn-primary w-100" type="submit">
              <i class="bi bi-cpu"></i> Upload & Process
            </button>
          </form>
          <p class="text-muted small mt-2 mb-0">Supports: PDF, PNG, JPG, TIFF (CNIC, EMR, ERP, Property)</p>
        </div>

        <!-- Extracted Data Card -->
        {% if extracted_data %}
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-braces"></i> Extracted Data</h5>
            {% if json_file %}
            <a href="/download?json_file={{ json_file }}" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-download"></i> Download JSON
            </a>
            {% endif %}
          </div>
          
          {% if extracted_data.DOCtype %}
          <span class="badge bg-info mb-2">{{ extracted_data.DOCtype }}</span>
          {% endif %}
          
          <div class="output-box">
            <pre class="mb-0">{{ extracted_data | tojson(indent=2) }}</pre>
          </div>
        </div>
        {% else %}
        <div class="card p-4">
          <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Upload a document to extract structured fields.</p>
        </div>
        {% endif %}
      </div>

      <!-- Right Column: Semantic Search -->
      <div class="col-lg-6">
        <!-- Search Card -->
        <div class="card p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-search"></i> Semantic Search</h5>
          {% if embedding_enabled %}
          <form method="POST">
            <div class="input-group mb-2">
              <input type="text" class="form-control" name="search_query" 
                     placeholder="e.g., Find CNIC for Ali Khan" 
                     value="{{ search_query }}" required>
              <button class="btn btn-success" type="submit">
                <i class="bi bi-search"></i> Search
              </button>
            </div>
          </form>
          <p class="text-muted small mb-0">Search documents using natural language queries</p>
          {% else %}
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle"></i> Embedding pipeline not available.
          </div>
          {% endif %}
        </div>

        <!-- Search Results Card -->
        <div class="card p-4">
          <h5 class="mb-3"><i class="bi bi-list-ul"></i> Search Results</h5>
          
          {% if search_results is not none %}
            {% if search_results | length > 0 %}
              <p class="text-muted small">Found {{ search_results | length }} result(s) for "<strong>{{ search_query }}</strong>"</p>
              
              {% for result in search_results %}
              <div class="search-result rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge doc-type-badge bg-primary">{{ result.DOCtype }}</span>
                  <span class="badge score-badge bg-{{ 'success' if result.score > 0.5 else 'warning' if result.score > 0.3 else 'secondary' }}">
                    Score: {{ result.score }}
                  </span>
                </div>
                
                <table class="table table-sm metadata-table mb-0">
                  <tbody>
                    {% for key, value in result.metadata.items() %}
                    {% if value and key not in ['rawtext', 'raw_text'] %}
                    <tr>
                      <td class="text-muted" style="width: 35%;">{{ key | replace('_', ' ') | title }}</td>
                      <td>
                        {% if value is iterable and value is not string %}
                          {{ value | join(', ') }}
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endfor %}
              
            {% else %}
              <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> No matching documents found for "<strong>{{ search_query }}</strong>"
              </div>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Enter a query above to search indexed documents.</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="text-center mt-4">
      <a href="/" class="btn btn-link"><i class="bi bi-arrow-clockwise"></i> Reset / New Upload</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
